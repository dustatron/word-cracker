import { useState, useMemo } from "react"
import type { NextPage } from "next"
import Head from "next/head"
import { Text, Flex, Box, Container, Button } from "@chakra-ui/react"
import LetterPicker from "../components/LetterPicker"
import GuessRow from "../components/GuessRow"
import { LetterState } from "../types"
import styles from "../styles/Home.module.css"
import { evalGuess } from "../utils"
import { wordList } from "../utils"

const Home: NextPage = () => {
  const [letterSet, setLetterSet] = useState<LetterState[]>([])
  const [history, setHistory] = useState<LetterState[][]>([])

  const masterWord = useMemo(() => {
    const words = wordList.split("\n")
    const wordSelects = words.filter((word) => word.length === 5)
    const masterWord =
      wordSelects[
        Math.floor(
          Math.random() * (1 - wordSelects.length) + wordSelects.length
        )
      ]
    return masterWord
  }, [])

  console.log("words", masterWord)

  const addALetter = (l: string) => {
    if (letterSet.length < 5) {
      const newLetterSet: LetterState[] = [
        ...letterSet,
        { letter: l, state: "guess" },
      ]
      setLetterSet(newLetterSet)
    }
  }

  const makeGuess = () => {
    if (letterSet.length === 5 && history.length !== 6) {
      const evalLetters = evalGuess(masterWord, letterSet)
      const newRow = [evalLetters, ...history]
      setHistory(newRow)
      setLetterSet([])
    }
  }

  const removeLastLetter = () => {
    if (letterSet.length >= 1) {
      const newLetterSet: LetterState[] = [...letterSet].slice(
        0,
        letterSet.length - 1
      )
      setLetterSet(newLetterSet)
    }
  }

  const handleStartOver = () => {
    setHistory([])
  }

  return (
    <div>
      <Head>
        <title>Word Cracker</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main>
        <Container>
          <Flex justifyContent="center">
            <Text as="h1" fontSize="36">
              Word Cracker
            </Text>
          </Flex>
          <Box>Litter guess</Box>
          <Box>
            <GuessRow letters={letterSet} index={0} />
            {history.map((g, index) => (
              <GuessRow
                key={`${index}-${index}`}
                letters={g}
                index={index + 1}
              />
            ))}
          </Box>
          <LetterPicker
            addALetter={addALetter}
            makeGuess={makeGuess}
            removeLastLetter={removeLastLetter}
            isGuessReady={letterSet.length !== 5}
          />
          <Button onClick={handleStartOver}>Start Over</Button>
        </Container>
      </main>

      <footer className={styles.footer}>
        <a
          href="https://www.pdxmccord.com"
          target="_blank"
          rel="noopener noreferrer"
        >
          Powered by PDX-McCord
        </a>
      </footer>
    </div>
  )
}

export default Home
